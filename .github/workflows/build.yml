name: Build

on:
    push:
    pull_request:

env:
    CARGO_TERM_COLOR: always

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            # Install Rust toolchain with embedded target
            - uses: dtolnay/rust-toolchain@stable
              with:
                  targets: thumbv7m-none-eabi
                  components: rustfmt, clippy

            # Cache Cargo dependencies
            - uses: Swatinem/rust-cache@v2

            # Build the project for embedded target
            - name: Build (debug)
              run: cargo build --verbose --target thumbv7m-none-eabi

            - name: Build (release)
              run: cargo build --verbose --target thumbv7m-none-eabi --release

            # Run Cargo check
            - name: Cargo check
              run: cargo check --target thumbv7m-none-eabi

            # Run Clippy for linting
            - name: Clippy
              run: cargo clippy --target thumbv7m-none-eabi -- -D warnings

            # Check formatting
            - name: Format check
              run: cargo fmt --all -- --check

            # Setup Python for pre-commit hooks
            - uses: actions/setup-python@v5
              with:
                  python-version: "3.x"

            - name: Install and run pre-commit
              run: |
                  pip install pre-commit
                  pre-commit run --show-diff-on-failure --color=always --all-files
